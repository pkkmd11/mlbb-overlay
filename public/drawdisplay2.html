<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Selection Display - CS2 Style</title>
    <style>
        @font-face {
            font-family: 'Big Noodle Titling';
            src: url('Assets/Font/big_noodle_titling.ttf') format('truetype');
        }
        :root {
            --background-color: #0D0F12;
            --card-color: #1A1C20;
            --font-color: #EAEAEA;
            --accent-color: #A855F7;
            --accent-glow: rgba(168, 85, 247, 0.5);
            --border-color: #3f3f46;
            --active-color: #6c008d;
            --card-width: 200px;
            --card-gap: 16px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Big Noodle Titling', sans-serif;
            background-color: var(--background-color);
            color: var(--font-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            letter-spacing: 1.5px;
            overflow: hidden;
            scale: 1.4;
        }
        
        .viewport {
            width: 100%;
            max-width: 1200px;
            height: calc(var(--card-width) * 0.8 + 20px);
            position: relative;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
            mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
        }

        .viewport::after {
            content: '';
            position: absolute;
            top: -10px;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            background-color: var(--active-color);
            box-shadow: 0 0 15px 3px var(--active-color);
            z-index: 5;
            border-radius: 2px;
            transition: opacity 1.5s ease-out;
        }

        .viewport.result-decided::after {
            opacity: 0.3;
        }

        .map-reel {
            display: flex;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            gap: var(--card-gap);
            padding: 10px 0;
            will-change: transform;
        }

        .map-card {
            width: var(--card-width);
            height: calc(var(--card-width) * 0.8);
            flex-shrink: 0;
            opacity: 0.7;
        }
        
        .map-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .map-card.selected {
            animation: 
                select-and-glow 0.6s ease-out forwards,
                final-breath 2s 0.6s infinite ease-in-out;
            border-color: var(--aura-color, #fff);
        }

        @keyframes select-and-glow {
            from { opacity: 0.7; transform: scale(1); box-shadow: none; }
            to { opacity: 1; transform: scale(1.05); box-shadow: 0 0 35px 8px var(--aura-color, #fff); }
        }

        @keyframes final-breath {
            0%, 100% { transform: scale(1.05); box-shadow: 0 0 35px 8px var(--aura-color, #fff); }
            50% { transform: scale(1.1); box-shadow: 0 0 55px 15px var(--aura-color, #fff); }
        }

        .hide { display: none; }
    </style>
</head>
<body>
    <div class="viewport">
        <div class="map-reel">
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const reel = document.querySelector('.map-reel');
            const viewport = reel.parentElement;
            
            const maps = [
                { name: 'Broken Wall', color: '#a0522d' },
                { name: 'Dangereous Grass', color: '#2e8b57' },
                { name: 'Expanding River', color: '#4682b4' },
                { name: 'Flying Cloud', color: '#add8e6' },
            ];
            
            const REEL_REPEAT_COUNT = 50;
            let animationFrameId;
            let reelItems = [];

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function populateReel() {
                reel.innerHTML = '';
                reelItems = [];
                for (let i = 0; i < REEL_REPEAT_COUNT; i++) {
                    const items = (i < REEL_REPEAT_COUNT - 5) ? shuffle([...maps]) : [...maps];
                    reelItems.push(...items);
                }

                reelItems.forEach((map, index) => {
                    const card = document.createElement('div');
                    card.className = 'map-card';
                    card.dataset.index = index;
                    card.style.setProperty('--aura-color', map.color);
                    card.innerHTML = `<img src="Assets/map/${map.name}.png" alt="${map.name}">`;
                    reel.appendChild(card);
                });
            }

            // Init awal
            populateReel();

            function resetDisplay() {
                cancelAnimationFrame(animationFrameId);
                reel.style.transition = 'none';
                reel.style.transform = `translateX(0px)`;
                
                viewport.classList.remove('result-decided');
                document.querySelectorAll('.map-card.selected').forEach(c => {
                    c.classList.remove('selected');
                    c.style.animation = ''; 
                });
            }

            // Fungsi Helper untuk mencari posisi target di reel
            function getTargetParams(targetResult) {
                const targetSetIndex = REEL_REPEAT_COUNT - 3; 
                const startIndexInFullList = targetSetIndex * maps.length;
                const relativeIndex = reelItems.slice(startIndexInFullList).findIndex(m => m.name === targetResult);
                
                if (relativeIndex === -1) return null;

                const finalIndex = startIndexInFullList + relativeIndex;
                
                const cardWidth = 200; 
                const cardGap = 16;   
                const viewportCenter = viewport.offsetWidth / 2;
                const cardCenter = (finalIndex * (cardWidth + cardGap)) + (cardWidth / 2);
                const targetX = viewportCenter - cardCenter;

                return { targetX, finalIndex };
            }

            // FUNGSI BARU: Langsung loncat ke hasil tanpa animasi
            function jumpToResult(targetResult) {
                resetDisplay();
                
                // Karena populateReel() mengacak ulang saat refresh, 
                // kita harus mencari ulang posisi targetResult di reel yang baru digenerate ini.
                const params = getTargetParams(targetResult);
                
                if (!params) {
                    console.error("Target not found for jump:", targetResult);
                    return;
                }

                // Langsung set posisi CSS
                reel.style.transform = `translateX(${params.targetX}px)`;
                
                // Langsung set efek visual
                const winnerCard = document.querySelector(`.map-card[data-index='${params.finalIndex}']`);
                if (winnerCard) {
                    viewport.classList.add('result-decided');
                    winnerCard.classList.add('selected');
                }
            }

            function startAnimation(targetResult) {
                resetDisplay();
                
                const params = getTargetParams(targetResult);
                if (!params) return;

                const winnerCard = document.querySelector(`.map-card[data-index='${params.finalIndex}']`);
                
                const duration = 8000; 
                const easeOutQuint = t => 1 - Math.pow(1 - t, 5);
                let startTime = null;

                function animationLoop(currentTime) {
                    if (!startTime) startTime = currentTime;
                    const elapsedTime = currentTime - startTime;
                    const progress = Math.min(elapsedTime / duration, 1);
                    const easedProgress = easeOutQuint(progress);

                    const currentX = easedProgress * params.targetX;
                    reel.style.transform = `translateX(${currentX}px)`;

                    if (progress < 1) {
                        animationFrameId = requestAnimationFrame(animationLoop);
                    } else {
                        reel.style.transform = `translateX(${params.targetX}px)`;
                        viewport.classList.add('result-decided');
                        if(winnerCard) winnerCard.classList.add('selected');
                    }
                }
                animationFrameId = requestAnimationFrame(animationLoop);
            }

            // --- KONEKSI SERVER ---

            fetch('/api/mapdraw')
                .then(res => res.json())
                .then(data => {
                    const state = data.drawdata;
                    // PERBAIKAN DI SINI:
                    // Jika status sudah finished atau drawing saat refresh, gunakan jumpToResult
                    if (state.status === 'finished' || state.status === 'drawing') {
                         jumpToResult(state.result); 
                    }
                })
                .catch(err => console.error("Error loading initial state:", err));

            const socketProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${socketProtocol}//${window.location.host}`;
            const ws = new WebSocket(socketUrl);

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                if (message.type === 'mapdraw_update') {
                    const newState = message.data;
                    
                    if (newState.status === 'drawing') {
                        // Hanya animasi jika update datang dari WebSocket (live)
                        startAnimation(newState.result);
                    } else if (newState.status === 'idle') {
                        resetDisplay();
                        // populateReel ulang agar urutan acak lagi untuk putaran berikutnya
                        populateReel();
                    }
                }
            };
            
            ws.onopen = () => console.log('Connected to MapDraw WebSocket (CS2 Style)');
        });
    </script>
</body>
</html>